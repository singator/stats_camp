---
title: "hrv2"
author: "Vik Gopal"
date: "14 May 2019"
output: html_document
---

```{r load_libraries, message=FALSE, warning=FALSE}
library(RHRV)
library(tidyverse)

create_nihr <- function(fname) {
  obj <- CreateHRVData()
  vec1 <- read.table(fname)[,1]
  vec1 <- vec1 - vec1[1]
  obj <- LoadBeatVector(obj, vec1, scale = 0.001)
  obj <- BuildNIHR(obj)
  obj <- SetVerbose(obj, TRUE)
  obj
}
```

## Template plots and analysis

* Read in baseline, exercise and music hrs
* Overlay them (requires zero-ing of time)
    * Display standard errors, outliers, summaries, smooths
* Function to detect return to baseline
    * find first 15 sec window where HR is within limits (??)
    * fit a piecewise linear regression to identify changepoint
    * Poincare plot
* Can we use Poincare plot to detect episodes? Can we use the point at which
correlation drops back to zero?
* Work on storing hr objects in a tibble or data frame.

## Read in files

```{r}
# Load and plot baseline
base_hr <- create_nihr("baseline.txt")
base2 <- FilterNIHR(base_hr)

ex_hr <- create_nihr("after_exercise.txt")
PlotNIHR(ex_hr)

music_hr <-  create_nihr("during_music.txt")
music2 <- FilterNIHR(music_hr)
PlotNIHR(music2)
```

## Overlay Two HR series

```{r}
ex2 <- FilterNIHR(ex_hr)
PlotNIHR(ex2, col="red")
lines(base2$Beat$Time, base2$Beat$niHR, col="gray")
```

## Display Baseline with Mean and SD

This displays the baseline HR (interpolated), along with the 2-sd (95%) 
interval.
```{r}
base2 <- InterpolateNIHR(base2)
UL <- mean(base2$HR) + 1.96*sd(base2$HR)
LL <- mean(base2$HR) - 1.96*sd(base2$HR)
PlotHR(base2)
abline(h=c(UL, LL), col="red", lty=2)
```

Now we try to show the exercise related HR, along with the limits for the 
baseline.
```{r}
ex2 <- InterpolateNIHR(ex2)
PlotHR(ex2, col="red")
abline(h=c(UL, LL), col="blue", lty=2)
```

## Poincare plot and episodes

```{r}
base2 <- CreateNonLinearAnalysis(base2)
PoincarePlot(base2, doPlot = TRUE)

ex2 <- CreateNonLinearAnalysis(ex2)
PoincarePlot(ex2, doPlot = TRUE)
```

## Create and display episodes

```{r}
ex3 <- AddEpisodes(ex2, InitTimes = c(0, 50), Duration=c(50, 130), 
                   Tags=c("recovery", "recovered"), Values=c(0,0))
PlotHR(ex3, Tags="all")
```

What kind rules can we introduce to discuss change-point detection?

## Functions to detect return to baseline

### First method
```{r}
detect1 <- function(base_obj, ex_obj) {
  print("pass for now")
}
```



